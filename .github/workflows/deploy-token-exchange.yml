name: Deploy token exchange

# This workflow assumes that the Terraform infrastructure in
# `token-exchange/tf/` has already been set up.

on:
    workflow_dispatch:
      inputs:
        project_number:
          description: 'The GCP project number where the token exchange service will be deployed.'
          required: true
          type: 'string'
        project_id:
          description: 'The GCP project ID where the token exchange service will be deployed.'
          required: true
          type: 'string'
        location:
          description: 'The GCP location where the token exchange service will be deployed.'
          required: true
          type: 'string'

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: 'read'
            id-token: 'write'
        steps:
            - uses: actions/checkout@v2
              with:
                repository: abcxyz/github-token-minter
                ref: bff0776c3a11ddee36c5b9fc72299bd35994a075 # v2.3.2

            - uses: google-github-actions/auth@v2
              with:
                workload_identity_provider: projects/${{inputs.project_number}}/locations/global/workloadIdentityPools/ci-pipeline/providers/github-actions
                service_account: token-exchange-deployer@${{inputs.project_id}}.iam.gserviceaccount.com

            - uses: ko-build/setup-ko@v0.9
              env:
                KO_DOCKER_REPO: ${{inputs.location}}-docker.pkg.dev/${{inputs.project_id}}/token-exchange-images
            - run: |
                IMAGE_NAME=$(ko build ./cmd/minty)
                echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV

            - id: deploy
              uses: 'google-github-actions/deploy-cloudrun@v2'
              with:
                service: github-token-exchange
                image: ${{env.IMAGE_NAME}}

            - run: 'echo "Service deployed to ${{ steps.deploy.outputs.url }}"'
