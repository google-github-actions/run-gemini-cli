import * as fs from 'node:fs';
import * as path from 'node:path';

interface VitestReport {
  testResults: {
    assertionResults: {
      title: string;
      status: 'passed' | 'failed' | 'skipped';
      failureMessages: string[];
      duration: number;
    }[];
  }[];
}

function main() {
  const reportPath = process.argv[2];
  if (!reportPath || !fs.existsSync(reportPath)) {
    console.error(
      'Usage: ts-node aggregate_evals.ts <path-to-vitest-report.json>',
    );
    process.exit(1);
  }

  const report: VitestReport = JSON.parse(fs.readFileSync(reportPath, 'utf-8'));

  let total = 0;
  let passed = 0;
  let totalDuration = 0;
  const failures: { title: string; message: string }[] = [];

  for (const testResult of report.testResults) {
    for (const assertion of testResult.assertionResults) {
      total++;
      totalDuration += assertion.duration || 0;
      if (assertion.status === 'passed') {
        passed++;
      } else if (assertion.status === 'failed') {
        failures.push({
          title: assertion.title,
          message: assertion.failureMessages.join('\n'),
        });
      }
    }
  }

  const passRateRaw = total > 0 ? (passed / total) * 100 : 0;
  const passRate = passRateRaw.toFixed(1);
  const avgDuration = total > 0 ? (totalDuration / total / 1000).toFixed(2) : 0;

  console.log(`## üìä Gemini CLI Quality Report`);
  console.log(`- **Pass Rate:** ${passRate}% (${passed}/${total})`);
  console.log(`- **Avg Latency:** ${avgDuration}s`);
  console.log(``);

  if (failures.length > 0) {
    console.log(`### ‚ùå Failures (${failures.length})`);
    for (const failure of failures) {
      console.log(`<details>`);
      console.log(`<summary><b>${failure.title}</b></summary>`);
      console.log(``);
      console.log('```');
      console.log(failure.message);
      console.log('```');
      console.log(`</details>`);
    }
  } else {
    console.log(`### ‚úÖ All functional benchmarks passed!`);
  }

  console.log(`\n---\n*Generated by evaluation framework*`);

  if (passRateRaw < 90) {
    console.error(`\n‚ùå Pass rate ${passRate}% is below the 90% threshold.`);
    process.exit(1);
  } else {
    console.log(`\n‚úÖ Pass rate ${passRate}% meets the 90% threshold.`);
  }
}

main();
